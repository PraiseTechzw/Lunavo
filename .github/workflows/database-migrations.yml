name: Database Migrations

on:
    push:
        branches:
            - main
            - master
        paths:
            - "supabase/migrations/**"
    workflow_dispatch:

jobs:
    migrate:
        name: Run Database Migrations
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ— Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ— Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x

            - name: ğŸ“¦ Install Supabase CLI
              run: npm install -g supabase

            - name: ğŸ”— Link to Supabase project
              run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
              env:
                  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

            - name: ğŸš€ Run migrations
              run: supabase db push
              env:
                  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
                  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

            - name: âœ… Verify migrations
              run: supabase db diff
              env:
                  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

            - name: ğŸ’¬ Notify on success
              if: success()
              run: echo "âœ… Database migrations completed successfully!"

            - name: âŒ Notify on failure
              if: failure()
              run: |
                  echo "âŒ Database migrations failed!"
                  exit 1
