name: EAS Update - OTA

on:
    push:
        branches:
            - main
            - master
            - develop
        paths:
            - "app/**"
            - "lib/**"
            - "assets/**"
            - "package.json"
    workflow_dispatch:
        inputs:
            channel:
                description: "Update channel"
                required: true
                default: "production"
                type: choice
                options:
                    - production
                    - preview
                    - development

jobs:
    publish-update:
        name: Publish OTA Update
        runs-on: ubuntu-latest
        steps:
            - name: ğŸ— Checkout repository
              uses: actions/checkout@v4

            - name: ğŸ— Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: 20.x
                  cache: npm

            - name: ğŸ— Setup Expo
              uses: expo/expo-github-action@v8
              with:
                  eas-version: latest
                  token: ${{ secrets.EXPO_TOKEN }}

            - name: ğŸ“¦ Install dependencies
              run: npm ci

            - name: ğŸ” Run linter
              run: npm run lint --fix

            - name: ğŸš€ Publish update (Production)
              if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event.inputs.channel == 'production'
              run: eas update --branch production --message "${{ github.event.head_commit.message || 'Manual update' }}" --non-interactive

            - name: ğŸš€ Publish update (Preview)
              if: github.ref == 'refs/heads/staging' || github.event.inputs.channel == 'preview'
              run: eas update --branch preview --message "${{ github.event.head_commit.message || 'Manual update' }}" --non-interactive

            - name: ğŸš€ Publish update (Development)
              if: github.ref == 'refs/heads/develop' || github.event.inputs.channel == 'development'
              run: eas update --branch development --message "${{ github.event.head_commit.message || 'Manual update' }}" --non-interactive

            - name: ğŸ’¬ Notify on success
              if: success()
              run: echo "âœ… OTA update published successfully!"

            - name: âŒ Notify on failure
              if: failure()
              run: echo "âŒ OTA update failed!"
